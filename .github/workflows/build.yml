name: Build & Upload ESP32 Firmware OTA

permissions:
  contents: write

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      version_mode:
        description: "Versioning mode (override)"
        type: choice
        required: false
        default: combined
        options:
          - semver
          - timestamp
          - combined
      force_version:
        description: "Override version (e.g., v1.2.3 or 202508171230 or v1.2.3+202508171230)"
        type: string
        required: false
        default: ""

jobs:
  build-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (with tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio/.cache
            ~/.platformio/packages
            ~/.platformio/platforms
            ~/.platformio/penv
          key: pio-${{ runner.os }}-${{ hashFiles('platformio.ini') }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install PlatformIO
        run: pip install platformio
        
      - name: Compute VERSION (safe semver + timestamp)
        id: version
        shell: bash
        run: |
          set -euo pipefail

          FORCE="${{ github.event.inputs.force_version || '' }}"
          MODE="${{ github.event.inputs.version_mode || '' }}"

          # Default mode (for push)
          if [ -z "$MODE" ]; then MODE="combined"; fi

          # If manually forced version ‚Üí use it directly
          if [ -n "$FORCE" ]; then
            VERSION="$FORCE"
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "mode=$MODE" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üîç Ricerca ultimo tag (semver o semver+timestamp)‚Ä¶"

          # Match both:
          #   v1.4.11
          #   v1.4.11+202511282155
          RAW=$(git tag --list | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | sort -V | tail -n1)

          if [ -z "$RAW" ]; then
            echo "‚ö†Ô∏è Nessun tag trovato. Uso v0.0.0"
            RAW="v0.0.0"
          fi

          echo "‚û°Ô∏è Ultimo tag trovato: $RAW"

          # Extract clean semver by removing "+timestamp"
          TAG=$(echo "$RAW" | sed 's/+.*//')

          echo "‚û°Ô∏è Semver base estratto: $TAG"

          # Remove leading v
          BASE="${TAG#v}"

          # Extract MAJOR.MINOR.PATCH
          IFS='.' read -r MA MI PA <<< "$BASE"

          # Timestamp
          TS=$(date +%Y%m%d%H%M)

          case "$MODE" in
            semver)
              PA=$((PA + 1))
              VERSION="v${MA}.${MI}.${PA}"
              ;;
            timestamp)
              VERSION="$TS"
              ;;
            combined)
              PA=$((PA + 1))
              VERSION="v${MA}.${MI}.${PA}+${TS}"
              ;;
            *)
              PA=$((PA + 1))
              VERSION="v${MA}.${MI}.${PA}+${TS}"
              ;;
          esac

          echo "Computed VERSION = $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "mode=$MODE"       >> $GITHUB_OUTPUT

      - name: Show computed VERSION
        run: echo "Computed VERSION is '${{ env.VERSION }}'"

      - name: Create and push tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ env.VERSION }}
        run: |
          set -e

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          echo "üîç Verifico se il tag ${VERSION} esiste gi√†‚Ä¶"

          if git rev-parse "${VERSION}" >/dev/null 2>&1; then
            echo "‚ùå ERRORE: Il tag ${VERSION} esiste gi√†! Interrompo la pipeline."
            exit 1
          fi

          echo "üè∑  Creo nuovo tag: ${VERSION}"
          git tag "${VERSION}"

          echo "üöÄ Pushing tag‚Ä¶"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} "${VERSION}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: "Firmware ${{ env.VERSION }}"
          draft: false
          prerelease: false
          files: |
            .pio/build/esp32-prod/firmware.bin
            version.txt
          body: |
            Firmware ESP32 costruito automaticamente.
            Commit: ${{ github.sha }}
            Versione: ${{ env.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Build firmware (esp32-prod) with VERSION override
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          VERSION_OVERRIDE="${VERSION}" pio run -e esp32-prod

      - name: Show firmware version
        run: grep -oP '(?<=#define FIRMWARE_VERSION ")[^"]+' include/version_auto.h

      - name: Upload firmware as artifact
        uses: actions/upload-artifact@v4
        with:
          name: esp32-prod-${{ github.sha }}.bin
          path: .pio/build/esp32-prod/firmware.bin
          if-no-files-found: error
          retention-days: 7

      - name: (Optional) Create version.txt
        run: echo "$VERSION" > version.txt

      - name: Upload firmware to OTA server
        env:
          OTA_UPLOAD_URL: ${{ secrets.OTA_UPLOAD_URL }}
          OTA_TOKEN:      ${{ secrets.OTA_TOKEN }}
          VERSION:        ${{ env.VERSION }}
        run: |
          set -euo pipefail

          if [ -z "${OTA_UPLOAD_URL:-}" ]; then
            echo "‚ùå OTA_UPLOAD_URL secret mancante"; exit 1
          fi

          echo "‚û°Ô∏è  Upload verso: ${OTA_UPLOAD_URL}"
          echo "‚û°Ô∏è  Version: ${VERSION}"

          AUTH=()
          if [ -n "${OTA_TOKEN:-}" ]; then
            AUTH=(-H "Authorization: Bearer ${OTA_TOKEN}")
          fi

          curl --fail-with-body -sS -m 120 -L \
               "${AUTH[@]}" \
               -F "firmware=@.pio/build/esp32-prod/firmware.bin;type=application/octet-stream;filename=firmware.bin" \
               -F "version=${VERSION}" \
               -F "version_file=@version.txt;type=text/plain;filename=version.txt" \
               "${OTA_UPLOAD_URL}" \
               -w "\nHTTP %{http_code}\n"
